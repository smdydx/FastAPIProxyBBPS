"""
Biller management endpoints with CSV upload.
Optimized async operations with bulk insert/update.
"""

import logging
import csv
import io
import time
from typing import List, Dict, Set
from fastapi import APIRouter, Depends, UploadFile, File, HTTPException, Query
from sqlalchemy.ext.asyncio import AsyncSession
from sqlalchemy import select, update, func, and_
from sqlalchemy.dialects.postgresql import insert

from app.core.database import get_db
from app.models.models_v2 import Category, Biller
from app.schemas.biller_schemas import (
    CSVUploadResponse,
    BillerListResponse,
    CategoryResponse,
)

logger = logging.getLogger(__name__)

router = APIRouter(prefix="/biller-management", tags=["Biller Management"])


async def get_or_create_category(
    db: AsyncSession, category_name: str
) -> int:
    """
    Get existing category or create new one.

    Args:
        db: Database session
        category_name: Category name

    Returns:
        Category ID
    """
    # Check if category exists
    query = select(Category).where(Category.category_name == category_name)
    result = await db.execute(query)
    category = result.scalar_one_or_none()

    if category:
        return category.id

    # Create new category
    category_code = category_name.upper().replace(" ", "_")[:50]
    new_category = Category(
        category_name=category_name,
        category_code=category_code,
        is_active=True,
    )
    db.add(new_category)
    await db.flush()  # Get ID without committing
    logger.info(f"Created new category: {category_name} (ID: {new_category.id})")
    return new_category.id


@router.post("/upload-csv", response_model=CSVUploadResponse)
async def upload_billers_csv(
    file: UploadFile = File(..., description="CSV file with billers"),
    deactivate_missing: bool = Query(
        True,
        description="Deactivate billers not present in CSV",
    ),
    db: AsyncSession = Depends(get_db),
):
    """
    Upload billers from CSV file.

    CSV Format:
    ```
    blr_id,blr_name,blr_category_name,blr_coverage
    BLR001,Electric Company,Electricity,Nationwide
    BLR002,Water Board,Water,State-wide
    ```

    Process:
    1. Parse CSV file
    2. Extract unique categories and create if needed
    3. Insert/update billers (set is_active=True)
    4. Optionally deactivate billers not in CSV (set is_active=False)

    Returns:
        Statistics about the upload process
    """
    start_time = time.time()
    errors = []

    # Validate file type
    if not file.filename.endswith('.csv'):
        raise HTTPException(
            status_code=400,
            detail="File must be a CSV file (.csv extension)"
        )

    try:
        # Read CSV content
        contents = await file.read()
        csv_content = contents.decode('utf-8')
        csv_reader = csv.DictReader(io.StringIO(csv_content))

        # Required columns
        required_columns = {'blr_id', 'blr_name', 'blr_category_name'}
        if not required_columns.issubset(set(csv_reader.fieldnames or [])):
            raise HTTPException(
                status_code=400,
                detail=f"CSV must contain columns: {', '.join(required_columns)}"
            )

        # Parse CSV rows
        csv_billers: List[Dict] = []
        csv_biller_ids: Set[str] = set()
        categories_in_csv: Set[str] = set()

        for row_num, row in enumerate(csv_reader, start=2):
            try:
                blr_id = row.get('blr_id', '').strip()
                blr_name = row.get('blr_name', '').strip()
                category_name = row.get('blr_category_name', '').strip()
                coverage = row.get('blr_coverage', '').strip() or None

                # Validate required fields
                if not blr_id or not blr_name or not category_name:
                    errors.append(f"Row {row_num}: Missing required fields")
                    continue

                # Check for duplicates in CSV
                if blr_id in csv_biller_ids:
                    errors.append(f"Row {row_num}: Duplicate blr_id '{blr_id}'")
                    continue

                csv_billers.append({
                    'blr_id': blr_id,
                    'blr_name': blr_name,
                    'category_name': category_name,
                    'blr_coverage': coverage,
                })
                csv_biller_ids.add(blr_id)
                categories_in_csv.add(category_name)

            except Exception as e:
                errors.append(f"Row {row_num}: {str(e)}")

        if not csv_billers:
            raise HTTPException(
                status_code=400,
                detail="No valid billers found in CSV"
            )

        logger.info(f"Parsed {len(csv_billers)} billers from CSV with {len(categories_in_csv)} unique categories")

        # Step 1: Get or create categories
        category_map: Dict[str, int] = {}
        for category_name in categories_in_csv:
            category_id = await get_or_create_category(db, category_name)
            category_map[category_name] = category_id

        # Step 2: Get existing billers
        existing_query = select(Biller.blr_id, Biller.id).where(
            Biller.blr_id.in_(csv_biller_ids)
        )
        existing_result = await db.execute(existing_query)
        existing_billers = {row[0]: row[1] for row in existing_result.all()}

        # Step 3: Prepare bulk operations
        billers_to_insert = []
        billers_to_update = []

        for biller_data in csv_billers:
            blr_id = biller_data['blr_id']
            category_id = category_map[biller_data['category_name']]

            if blr_id in existing_billers:
                # Update existing biller
                billers_to_update.append({
                    'blr_id': blr_id,
                    'blr_name': biller_data['blr_name'],
                    'category_id': category_id,
                    'blr_coverage': biller_data['blr_coverage'],
                    'is_active': True,
                })
            else:
                # Insert new biller
                billers_to_insert.append({
                    'blr_id': blr_id,
                    'blr_name': biller_data['blr_name'],
                    'category_id': category_id,
                    'blr_coverage': biller_data['blr_coverage'],
                    'is_active': True,
                })

        # Step 4: Bulk insert new billers
        billers_added = 0
        if billers_to_insert:
            # PostgreSQL-specific bulk insert
            stmt = insert(Biller).values(billers_to_insert)
            await db.execute(stmt)
            billers_added = len(billers_to_insert)
            logger.info(f"Inserted {billers_added} new billers")

        # Step 5: Bulk update existing billers
        billers_updated = 0
        if billers_to_update:
            # Update using PostgreSQL upsert
            for biller in billers_to_update:
                stmt = (
                    update(Biller)
                    .where(Biller.blr_id == biller['blr_id'])
                    .values(
                        blr_name=biller['blr_name'],
                        blr_alias_name=biller['blr_alias_name'],
                        blr_category_name=biller['blr_category_name'],
                        blr_coverage=biller['blr_coverage']
                        # is_active=True,
                    )
                )
                await db.execute(stmt)
            billers_updated = len(billers_to_update)
            logger.info(f"Updated {billers_updated} existing billers")

        # Step 6: Deactivate billers not in CSV
        # billers_deactivated = 0
        # if deactivate_missing:
        #     # Deactivate billers not in CSV
        #     deactivate_stmt = (
        #         update(Biller)
        #         .where(
        #             and_(
        #                 Biller.blr_id.notin_(csv_biller_ids),
        #                 Biller.is_active == True,
        #             )
        #         )
        #         .values(is_active=False)
        #     )
        #     deactivate_result = await db.execute(deactivate_stmt)
        #     billers_deactivated = deactivate_result.rowcount
        #     logger.info(f"Deactivated {billers_deactivated} billers not in CSV")

        # # Commit transaction
        # await db.commit()

        # Step 7: Get final statistics
        total_active_query = select(func.count(Biller.id)).where(
            Biller.is_active == True
        )
        total_active_result = await db.execute(total_active_query)
        total_active_billers = total_active_result.scalar()

        processing_time = time.time() - start_time

        return CSVUploadResponse(
            success=True,
            message=f"Successfully processed {len(csv_billers)} billers from CSV",
            statistics={
                "total_rows_in_csv": len(csv_billers),
                "valid_rows": len(csv_billers),
                "invalid_rows": len(errors),
                "unique_categories": len(categories_in_csv),
            },
            categories_processed=list(categories_in_csv),
            billers_added=billers_added,
            billers_updated=billers_updated,
            billers_deactivated=billers_deactivated,
            total_active_billers=total_active_billers,
            errors=errors if errors else None,
            processing_time=round(processing_time, 3),
        )

    except HTTPException:
        raise
    except Exception as e:
        await db.rollback()
        logger.error(f"Error processing CSV: {e}", exc_info=True)
        raise HTTPException(
            status_code=500,
            detail=f"Error processing CSV: {str(e)}"
        )


@router.get("/billers", response_model=BillerListResponse)
async def get_all_billers(
    active_only: bool = Query(True, description="Show only active billers"),
    category_id: int = Query(None, description="Filter by category"),
    skip: int = Query(0, ge=0),
    limit: int = Query(100, ge=1, le=1000),
    db: AsyncSession = Depends(get_db),
):
    """
    Get all billers with filtering options.

    Performance: Uses composite indexes for fast queries.
    """
    # Build query
    query = select(Biller, Category).join(Category)

    # Apply filters
    if active_only:
        query = query.where(Biller.is_active == True)

    if category_id:
        query = query.where(Biller.category_id == category_id)

    # Order and paginate
    query = query.order_by(Category.category_name, Biller.blr_name).offset(skip).limit(limit)

    result = await db.execute(query)
    rows = result.all()

    # Get counts
    total_query = select(func.count(Biller.id))
    total_result = await db.execute(total_query)
    total = total_result.scalar()

    active_query = select(func.count(Biller.id)).where(Biller.is_active == True)
    active_result = await db.execute(active_query)
    active = active_result.scalar()

    return BillerListResponse(
        success=True,
        total=total,
        active=active,
        inactive=total - active,
        billers=[
            {
                "id": biller.id,
                "blr_id": biller.blr_id,
                "blr_name": biller.blr_name,
                "category_id": biller.category_id,
                "category_name": category.category_name,
                "blr_coverage": biller.blr_coverage,
                "is_active": biller.is_active,
                "created_at": biller.created_at.isoformat(),
                "updated_at": biller.updated_at.isoformat() if biller.updated_at else None,
            }
            for biller, category in rows
        ],
    )


@router.get("/categories", response_model=List[CategoryResponse])
async def get_all_categories(
    active_only: bool = Query(True, description="Show only active categories"),
    db: AsyncSession = Depends(get_db),
):
    """Get all categories."""
    query = select(Category)

    if active_only:
        query = query.where(Category.is_active == True)

    query = query.order_by(Category.category_name)

    result = await db.execute(query)
    categories = result.scalars().all()

    return categories


@router.post("/billers/{blr_id}/toggle-active")
async def toggle_biller_active(
    blr_id: str,
    db: AsyncSession = Depends(get_db),
):
    """Toggle biller active status."""
    # Get biller
    query = select(Biller).where(Biller.blr_id == blr_id)
    result = await db.execute(query)
    biller = result.scalar_one_or_none()

    if not biller:
        raise HTTPException(status_code=404, detail=f"Biller '{blr_id}' not found")

    # Toggle status
    new_status = not biller.is_active
    stmt = (
        update(Biller)
        .where(Biller.blr_id == blr_id)
        .values(is_active=new_status)
    )
    await db.execute(stmt)
    await db.commit()

    return {
        "success": True,
        "blr_id": blr_id,
        "is_active": new_status,
        "message": f"Biller {'activated' if new_status else 'deactivated'}",
    }


@router.get("/stats")
async def get_biller_stats(db: AsyncSession = Depends(get_db)):
    """Get biller statistics."""
    # Total billers
    total_query = select(func.count(Biller.id))
    total_result = await db.execute(total_query)
    total = total_result.scalar()

    # Active billers
    active_query = select(func.count(Biller.id)).where(Biller.is_active == True)
    active_result = await db.execute(active_query)
    active = active_result.scalar()

    # Billers by category
    category_query = (
        select(Category.category_name, func.count(Biller.id).label("count"))
        .join(Biller)
        .where(Biller.is_active == True)
        .group_by(Category.category_name)
        .order_by(func.count(Biller.id).desc())
    )
    category_result = await db.execute(category_query)
    categories = category_result.all()

    return {
        "total_billers": total,
        "active_billers": active,
        "inactive_billers": total - active,
        "active_percentage": round((active / total * 100) if total > 0 else 0, 2),
        "by_category": [
            {"category": cat, "count": count} for cat, count in categories
        ],
    }
